{% extends "base.html" %}

{% block title %}äº¬ä¸œ - å…¥ä»“é¢„ä¼° - ç”µå•†è¿è¥æ•°æ®åˆ†æ{% endblock %}

{% block content %}
<!-- é¡µé¢å¤´éƒ¨ -->
<section class="page-header">
    <div class="breadcrumb">
        <a href="{{ url_for('index') }}">é¦–é¡µ</a>
        <span>/</span>
        <a href="{{ url_for('platform_index', platform_id='jd') }}">äº¬ä¸œ</a>
        <span>/</span>
        <span>å…¥ä»“é¢„ä¼°</span>
    </div>
    
    <div class="page-header-content">
        <div class="page-icon" style="--platform-color: {{ platform.color }}">ğŸ“¦</div>
        <div>
            <h1 class="page-title">äº¬ä¸œ - å…¥ä»“é¢„ä¼°</h1>
            <p class="page-desc">æ ¹æ®å†å²é”€é‡é¢„ä¼°å…¥ä»“æ•°é‡</p>
        </div>
    </div>
</section>

<!-- ä¸»å†…å®¹åŒº -->
<section class="formulas-section">
    <div class="formula-card rucang-card" id="rucang">
        <!-- å…¬å¼å¤´éƒ¨ -->
        <div class="formula-header">
            <div class="formula-title-group">
                <h2 class="formula-name">å…¥ä»“æ•°é‡é¢„ä¼°</h2>
                <span class="formula-english">Warehouse Stock Forecast</span>
            </div>
        </div>

        <!-- å…¬å¼å†…å®¹åŒº -->
        <div class="formula-body rucang-body">
            <!-- å·¦ä¾§ï¼šåŠŸèƒ½è¯´æ˜ -->
            <div class="formula-info">
                <!-- åŠŸèƒ½è¯´æ˜ -->
                <div class="formula-description">
                    <h4 class="info-label">ğŸ“– åŠŸèƒ½è¯´æ˜</h4>
                    <p>æ ¹æ®å•†å“çš„å†å²é”€é‡æ•°æ®ï¼Œä½¿ç”¨åŠ æƒå¹³å‡ç®—æ³•é¢„ä¼°æœªæ¥30å¤©çš„é”€å”®éœ€æ±‚ï¼Œå¹¶è®¡ç®—å»ºè®®å…¥ä»“æ•°é‡ã€‚</p>
                    <p>æ”¯æŒä¸Šä¼ Excelæ–‡ä»¶æ‰¹é‡è®¡ç®—ï¼Œæä¾›æ¨¡æ¿ä¸‹è½½å’Œç»“æœå¯¼å‡ºåŠŸèƒ½ã€‚</p>
                </div>

                <!-- åº”ç”¨åœºæ™¯ -->
                <div class="formula-application">
                    <h4 class="info-label">ğŸ’¡ åº”ç”¨åœºæ™¯</h4>
                    <p>é€‚ç”¨äºäº¬ä¸œè‡ªè¥å•†å“çš„åº“å­˜ç®¡ç†ï¼Œå¸®åŠ©å•†å®¶ï¼š</p>
                    <ul class="formula-notes">
                        <li>æ ¹æ®è¿‘æœŸé”€é‡è¶‹åŠ¿ç§‘å­¦é¢„æµ‹æœªæ¥éœ€æ±‚</li>
                        <li>é¿å…åº“å­˜ç§¯å‹æˆ–ç¼ºè´§æƒ…å†µ</li>
                        <li>ä¼˜åŒ–ä»“å‚¨æˆæœ¬å’Œèµ„é‡‘å‘¨è½¬</li>
                        <li>æå‰è§„åˆ’è¡¥è´§è®¡åˆ’</li>
                    </ul>
                </div>

                <!-- è®¡ç®—å…¬å¼ -->
                <div class="formula-critical">
                    <h4 class="info-label">ğŸ“ è®¡ç®—é€»è¾‘</h4>
                    <div class="critical-content">
                        <p><strong>1. è®¡ç®—å„å‘¨æœŸæ—¥å‡é”€é‡ï¼š</strong></p>
                        <p>â€¢ 7å¤©æ—¥å‡ = 7å¤©é”€é‡ Ã· 7</p>
                        <p>â€¢ 15å¤©æ—¥å‡ = 15å¤©é”€é‡ Ã· 15</p>
                        <p>â€¢ 30å¤©æ—¥å‡ = 30å¤©é”€é‡ Ã· 30</p>
                        <p>â€¢ 90å¤©æ—¥å‡ = 90å¤©é”€é‡ Ã· 90</p>
                        
                        <p style="margin-top: 1rem;"><strong>2. åŠ æƒå¹³å‡è®¡ç®—ï¼š</strong></p>
                        <p>åŠ æƒæ—¥å‡ = (7å¤©æ—¥å‡Ã—æƒé‡1 + 15å¤©æ—¥å‡Ã—æƒé‡2 + 30å¤©æ—¥å‡Ã—æƒé‡3 + 90å¤©æ—¥å‡Ã—æƒé‡4) Ã· æƒé‡æ€»å’Œ</p>
                        <p style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.5rem;">
                            é»˜è®¤æƒé‡ï¼š7å¤©=4ï¼Œ15å¤©=3ï¼Œ30å¤©=2ï¼Œ90å¤©=1ï¼ˆè¿‘æœŸæƒé‡æ›´å¤§ï¼‰
                        </p>
                        
                        <p style="margin-top: 1rem;"><strong>3. é¢„ä¼°é”€é‡ï¼š</strong></p>
                        <p>é¢„ä¼°30å¤©é”€é‡ = åŠ æƒæ—¥å‡ Ã— 30</p>
                        
                        <p style="margin-top: 1rem;"><strong>4. å»ºè®®å…¥ä»“æ•°é‡ï¼š</strong></p>
                        <p>å»ºè®®å…¥ä»“ = é¢„ä¼°30å¤©é”€é‡ Ã— å®‰å…¨ç³»æ•° - ç°æœ‰åº“å­˜</p>
                        <p style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.5rem;">
                            å®‰å…¨ç³»æ•°é»˜è®¤1.2ï¼Œè‹¥ç»“æœ < 0 åˆ™æ˜¾ç¤ºä¸º0
                        </p>
                    </div>
                </div>

                <!-- æ•°æ®ç¤ºä¾‹ -->
                <div class="formula-example">
                    <h4 class="info-label">ğŸ“Š æ•°æ®ç¤ºä¾‹</h4>
                    <div class="example-table">
                        <table class="mini-table">
                            <thead>
                                <tr>
                                    <th>å•†å“ID</th>
                                    <th>7å¤©é”€é‡</th>
                                    <th>15å¤©é”€é‡</th>
                                    <th>30å¤©é”€é‡</th>
                                    <th>90å¤©é”€é‡</th>
                                    <th>ç°æœ‰åº“å­˜</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>ç¤ºä¾‹001</td>
                                    <td>100</td>
                                    <td>180</td>
                                    <td>350</td>
                                    <td>1000</td>
                                    <td>50</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šæ“ä½œåŒºåŸŸ -->
            <div class="formula-calculator rucang-calculator">
                <h4 class="calculator-title">ğŸ“¤ ä¸Šä¼ æ•°æ®</h4>
                
                <!-- æ¨¡æ¿ä¸‹è½½ -->
                <div class="rucang-section">
                    <label class="rucang-label">ç¬¬ä¸€æ­¥ï¼šä¸‹è½½æ¨¡æ¿</label>
                    <a href="{{ url_for('jd_rucang_template') }}" class="download-template-btn" download>
                        <span>ğŸ“¥</span>
                        <span>ä¸‹è½½Excelæ¨¡æ¿</span>
                    </a>
                    <p class="help-text">ä¸‹è½½æ¨¡æ¿å¹¶æŒ‰æ ¼å¼å¡«å†™å•†å“æ•°æ®</p>
                </div>

                <!-- æ–‡ä»¶ä¸Šä¼  -->
                <div class="rucang-section">
                    <label class="rucang-label">ç¬¬äºŒæ­¥ï¼šä¸Šä¼ æ–‡ä»¶</label>
                    <div class="file-upload-area" id="file-upload-area">
                        <input type="file" id="file-input" accept=".xlsx" style="display: none;">
                        <div class="upload-placeholder" id="upload-placeholder">
                            <span class="upload-icon">ğŸ“</span>
                            <p>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ Excelæ–‡ä»¶</p>
                            <p class="upload-hint">æ”¯æŒ.xlsxæ ¼å¼</p>
                        </div>
                        <div class="upload-success" id="upload-success" style="display: none;">
                            <span class="success-icon">âœ“</span>
                            <p id="file-name"></p>
                            <button type="button" class="reupload-btn" onclick="resetUpload()">é‡æ–°ä¸Šä¼ </button>
                        </div>
                    </div>
                </div>

                <!-- å‚æ•°è®¾ç½® -->
                <div class="rucang-section">
                    <label class="rucang-label">ç¬¬ä¸‰æ­¥ï¼šå‚æ•°è®¾ç½®</label>
                    
                    <div class="param-group">
                        <label for="safety_factor">å®‰å…¨ç³»æ•°</label>
                        <input type="number" id="safety_factor" value="1.2" step="0.1" min="1" max="3" class="param-input">
                    </div>
                    
                    <div class="param-grid">
                        <div class="param-group">
                            <label for="weight_7">7å¤©æƒé‡</label>
                            <input type="number" id="weight_7" value="4" step="0.5" min="0" class="param-input">
                        </div>
                        <div class="param-group">
                            <label for="weight_15">15å¤©æƒé‡</label>
                            <input type="number" id="weight_15" value="3" step="0.5" min="0" class="param-input">
                        </div>
                        <div class="param-group">
                            <label for="weight_30">30å¤©æƒé‡</label>
                            <input type="number" id="weight_30" value="2" step="0.5" min="0" class="param-input">
                        </div>
                        <div class="param-group">
                            <label for="weight_90">90å¤©æƒé‡</label>
                            <input type="number" id="weight_90" value="1" step="0.5" min="0" class="param-input">
                        </div>
                    </div>
                </div>

                <!-- è®¡ç®—æŒ‰é’® -->
                <button type="button" class="calc-button" id="calculate-btn" onclick="calculateRucang()" disabled>
                    å¼€å§‹è®¡ç®—
                </button>
                
                <!-- åŠ è½½æç¤º -->
                <div class="loading" id="loading" style="display: none;">
                    <div class="loading-spinner"></div>
                    <p>è®¡ç®—ä¸­...</p>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- è®¡ç®—ç»“æœåŒºåŸŸ -->
<section class="result-section" id="result-section" style="display: none;">
    <!-- æ±‡æ€»ç»Ÿè®¡ -->
    <div class="summary-cards">
        <div class="summary-card">
            <div class="summary-icon">ğŸ“¦</div>
            <div class="summary-content">
                <h4>éœ€è¦å…¥ä»“å•†å“</h4>
                <p class="summary-value" id="need-count">--</p>
                <p class="summary-unit">ä¸ªå•†å“</p>
            </div>
        </div>
        <div class="summary-card">
            <div class="summary-icon">ğŸ“Š</div>
            <div class="summary-content">
                <h4>å…¥ä»“äº§å“ä»¶æ•°</h4>
                <p class="summary-value" id="total-qty">--</p>
                <p class="summary-unit">ä»¶</p>
            </div>
        </div>
        <div class="summary-card">
            <div class="summary-icon">ğŸ“‹</div>
            <div class="summary-content">
                <h4>æ€»å•†å“æ•°</h4>
                <p class="summary-value" id="total-products">--</p>
                <p class="summary-unit">ä¸ª</p>
            </div>
        </div>
    </div>

    <!-- ç»“æœè¡¨æ ¼ -->
    <div class="result-table-container">
        <div class="result-header">
            <h3>ğŸ“Š è®¡ç®—ç»“æœ</h3>
            <button class="export-btn" onclick="exportResults()">
                <span>ğŸ“¥</span>
                <span>å¯¼å‡ºExcel</span>
            </button>
        </div>
        <div class="table-wrapper">
            <table class="result-table" id="result-table">
                <thead>
                    <tr>
                        <th>å•†å“ID</th>
                        <th>7å¤©æ—¥å‡</th>
                        <th>15å¤©æ—¥å‡</th>
                        <th>30å¤©æ—¥å‡</th>
                        <th>90å¤©æ—¥å‡</th>
                        <th>é¢„ä¼°30å¤©é”€é‡</th>
                        <th>ç°æœ‰åº“å­˜</th>
                        <th>å»ºè®®å…¥ä»“æ•°é‡</th>
                        <th>æ˜¯å¦éœ€å…¥ä»“</th>
                    </tr>
                </thead>
                <tbody id="result-tbody">
                </tbody>
            </table>
        </div>
    </div>

    <!-- è®¡ç®—é€»è¾‘è¯´æ˜ -->
    <div class="logic-explanation">
        <h4>ğŸ“ æœ¬æ¬¡è®¡ç®—å‚æ•°</h4>
        <div class="logic-content">
            <p><strong>å®‰å…¨ç³»æ•°ï¼š</strong><span id="used-safety">--</span></p>
            <p><strong>æƒé‡è®¾ç½®ï¼š</strong>7å¤©=<span id="used-w7">--</span>ï¼Œ15å¤©=<span id="used-w15">--</span>ï¼Œ30å¤©=<span id="used-w30">--</span>ï¼Œ90å¤©=<span id="used-w90">--</span></p>
            <p style="margin-top: 1rem; font-size: 0.9rem; color: var(--text-muted);">
                é€šè¿‡åŠ æƒå¹³å‡ç®—æ³•ï¼Œè¿‘æœŸé”€é‡å…·æœ‰æ›´é«˜æƒé‡ï¼Œé¢„ä¼°ç»“æœæ›´è´´è¿‘å®é™…è¶‹åŠ¿ã€‚å®‰å…¨ç³»æ•°ç”¨äºé¢„ç•™ç¼“å†²åº“å­˜ï¼Œåº”å¯¹é”€é‡æ³¢åŠ¨ã€‚
            </p>
        </div>
    </div>
</section>

<!-- è¿”å›é“¾æ¥ -->
<section class="related-section">
    <h3 class="related-title">è¿”å›</h3>
    <div class="related-grid">
        <a href="{{ url_for('platform_index', platform_id='jd') }}" class="related-card">
            <span class="related-icon">ğŸ“¦</span>
            <span class="related-name">äº¬ä¸œé¦–é¡µ</span>
        </a>
        <a href="{{ url_for('jd_maobao') }}" class="related-card">
            <span class="related-icon">ğŸ›¡ï¸</span>
            <span class="related-name">è‡ªè¥æ¯›ä¿</span>
        </a>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
let uploadedFile = null;
let calculatedData = null;

// æ–‡ä»¶ä¸Šä¼ åŒºåŸŸç‚¹å‡»
document.getElementById('file-upload-area').addEventListener('click', function(e) {
    if (e.target.classList.contains('reupload-btn')) return;
    document.getElementById('file-input').click();
});

// æ–‡ä»¶é€‰æ‹©
document.getElementById('file-input').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        handleFileUpload(file);
    }
});

// æ‹–æ‹½ä¸Šä¼ 
const uploadArea = document.getElementById('file-upload-area');
uploadArea.addEventListener('dragover', function(e) {
    e.preventDefault();
    this.classList.add('dragover');
});

uploadArea.addEventListener('dragleave', function(e) {
    e.preventDefault();
    this.classList.remove('dragover');
});

uploadArea.addEventListener('drop', function(e) {
    e.preventDefault();
    this.classList.remove('dragover');
    const file = e.dataTransfer.files[0];
    if (file && file.name.endsWith('.xlsx')) {
        handleFileUpload(file);
    } else {
        alert('è¯·ä¸Šä¼ .xlsxæ ¼å¼æ–‡ä»¶');
    }
});

function handleFileUpload(file) {
    uploadedFile = file;
    document.getElementById('upload-placeholder').style.display = 'none';
    document.getElementById('upload-success').style.display = 'flex';
    document.getElementById('file-name').textContent = file.name;
    document.getElementById('calculate-btn').disabled = false;
}

function resetUpload() {
    uploadedFile = null;
    document.getElementById('file-input').value = '';
    document.getElementById('upload-placeholder').style.display = 'flex';
    document.getElementById('upload-success').style.display = 'none';
    document.getElementById('calculate-btn').disabled = true;
    document.getElementById('result-section').style.display = 'none';
}

async function calculateRucang() {
    if (!uploadedFile) {
        alert('è¯·å…ˆä¸Šä¼ æ–‡ä»¶');
        return;
    }

    const formData = new FormData();
    formData.append('file', uploadedFile);
    formData.append('safety_factor', document.getElementById('safety_factor').value);
    formData.append('weight_7', document.getElementById('weight_7').value);
    formData.append('weight_15', document.getElementById('weight_15').value);
    formData.append('weight_30', document.getElementById('weight_30').value);
    formData.append('weight_90', document.getElementById('weight_90').value);

    // æ˜¾ç¤ºåŠ è½½
    document.getElementById('loading').style.display = 'flex';
    document.getElementById('calculate-btn').disabled = true;

    try {
        const response = await fetch('/platform/jd/rucang/calculate', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (result.success) {
            calculatedData = result;
            displayResults(result);
        } else {
            alert('è®¡ç®—å¤±è´¥: ' + result.error);
        }
    } catch (error) {
        alert('è¯·æ±‚å¤±è´¥: ' + error.message);
    } finally {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('calculate-btn').disabled = false;
    }
}

function displayResults(result) {
    // æ˜¾ç¤ºç»“æœåŒºåŸŸ
    document.getElementById('result-section').style.display = 'block';
    
    // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
    setTimeout(() => {
        document.getElementById('result-section').scrollIntoView({ behavior: 'smooth' });
    }, 100);

    // æ±‡æ€»ç»Ÿè®¡
    document.getElementById('need-count').textContent = result.summary.need_rucang_count;
    document.getElementById('total-qty').textContent = result.summary.total_rucang_qty.toLocaleString();
    document.getElementById('total-products').textContent = result.summary.total_products;

    // è¡¨æ ¼æ•°æ®
    const tbody = document.getElementById('result-tbody');
    tbody.innerHTML = '';
    
    result.data.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${row['å•†å“ID']}</td>
            <td>${row['7å¤©æ—¥å‡']}</td>
            <td>${row['15å¤©æ—¥å‡']}</td>
            <td>${row['30å¤©æ—¥å‡']}</td>
            <td>${row['90å¤©æ—¥å‡']}</td>
            <td>${row['é¢„ä¼°30å¤©é”€é‡']}</td>
            <td>${row['ç°æœ‰åº“å­˜']}</td>
            <td class="highlight-number">${row['å»ºè®®å…¥ä»“æ•°é‡']}</td>
            <td><span class="status-badge ${row['æ˜¯å¦éœ€å…¥ä»“'] === 'æ˜¯' ? 'need' : 'no-need'}">${row['æ˜¯å¦éœ€å…¥ä»“']}</span></td>
        `;
        tbody.appendChild(tr);
    });

    // å‚æ•°è¯´æ˜
    document.getElementById('used-safety').textContent = result.params.safety_factor;
    document.getElementById('used-w7').textContent = result.params.weights['7å¤©'];
    document.getElementById('used-w15').textContent = result.params.weights['15å¤©'];
    document.getElementById('used-w30').textContent = result.params.weights['30å¤©'];
    document.getElementById('used-w90').textContent = result.params.weights['90å¤©'];
}

async function exportResults() {
    if (!calculatedData) {
        alert('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®');
        return;
    }

    try {
        const response = await fetch('/platform/jd/rucang/export', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                results: calculatedData.data,
                summary: calculatedData.summary,
                params: calculatedData.params
            })
        });

        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'å…¥ä»“é¢„ä¼°ç»“æœ_' + new Date().toISOString().slice(0, 10) + '.xlsx';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        } else {
            alert('å¯¼å‡ºå¤±è´¥');
        }
    } catch (error) {
        alert('å¯¼å‡ºå¤±è´¥: ' + error.message);
    }
}
</script>
{% endblock %}

{% set platforms = platforms %}
{% set metrics = metrics %}





