{% extends "base.html" %}

{% block title %}äº¬ä¸œ - è‡ªè¥æ¯›ä¿ - ç”µå•†è¿è¥æ•°æ®åˆ†æ{% endblock %}

{% block content %}
<!-- é¡µé¢å¤´éƒ¨ -->
<section class="page-header">
    <div class="breadcrumb">
        <a href="{{ url_for('index') }}">é¦–é¡µ</a>
        <span>/</span>
        <a href="{{ url_for('platform_index', platform_id='jd') }}">äº¬ä¸œ</a>
        <span>/</span>
        <span>è‡ªè¥æ¯›ä¿</span>
    </div>
    
    <div class="page-header-content">
        <div class="page-icon" style="--platform-color: {{ platform.color }}">ğŸ›¡ï¸</div>
        <div>
            <h1 class="page-title">äº¬ä¸œ - è‡ªè¥æ¯›ä¿</h1>
            <p class="page-desc">äº¬ä¸œè‡ªè¥æ¯›åˆ©ä¿æŠ¤è®¡ç®—å·¥å…·</p>
        </div>
    </div>
</section>

<!-- å…¬å¼å¡ç‰‡ -->
<section class="formulas-section">
    <div class="formula-card" id="maobao">
        <!-- å…¬å¼å¤´éƒ¨ -->
        <div class="formula-header">
            <div class="formula-title-group">
                <h2 class="formula-name">æ¯›åˆ©ä¿æŠ¤ï¼ˆæ¯›ä¿ï¼‰</h2>
                <span class="formula-english">Gross Profit Protection</span>
            </div>
        </div>

        <!-- å…¬å¼å†…å®¹åŒº -->
        <div class="formula-body">
            <!-- å·¦ä¾§ï¼šå…¬å¼è¯´æ˜ -->
            <div class="formula-info">
                <!-- å…¬å¼è¡¨è¾¾å¼ -->
                <div class="formula-expression">
                    <div class="expression-label">è®¡ç®—å…¬å¼</div>
                    <div class="expression-content">æ¯›ä¿è¡¥å·® = åˆ°æ‰‹ä»· Ã— æ‰¿è¯ºæ¯›ä¿ - (åˆ°æ‰‹ä»· - é‡‡è´­ä»·)</div>
                </div>

                <!-- å…¬å¼è¯´æ˜ -->
                <div class="formula-description">
                    <h4 class="info-label">ğŸ“– å…¬å¼è¯´æ˜</h4>
                    <p>å½“äº¬ä¸œæ¯›åˆ©ç‡ä½äºæ‰¿è¯ºæ¯”ä¾‹æ—¶ï¼Œéœ€è¦è¡¥å¿ç»™äº¬ä¸œçš„é‡‘é¢ã€‚</p>
                    <ul class="formula-notes">
                        <li>æ¯›ä¿è¡¥å·® <strong>&lt; 0</strong>ï¼šæ— éœ€è¡¥å·®ï¼Œå®é™…å›æ¬¾ = é‡‡è´­ä»·</li>
                        <li>æ¯›ä¿è¡¥å·® <strong>â‰¥ 0</strong>ï¼šéœ€è¦è¡¥å·®ï¼Œå®é™…å›æ¬¾ = é‡‡è´­ä»· - æ¯›ä¿è¡¥å·®</li>
                    </ul>
                </div>

                <!-- åº”ç”¨åœºæ™¯ -->
                <div class="formula-application">
                    <h4 class="info-label">ğŸ’¡ åº”ç”¨åœºæ™¯</h4>
                    <p>æ´»åŠ¨å®šä»·æ—¶ï¼Œç”¨æ¥é¢„ä¼°è¿”åˆ©å•äº§ç”Ÿçš„æ¯›ä¿é‡‘é¢ã€‚å¸®åŠ©å•†å®¶åœ¨åˆ¶å®šä¿ƒé”€ä»·æ ¼æ—¶ï¼Œæå‰è®¡ç®—å¯èƒ½éœ€è¦è¡¥å·®çš„é‡‘é¢ï¼Œé¿å…åˆ©æ¶¦æŸå¤±ã€‚</p>
                </div>

                <!-- ç¤ºä¾‹æ•°æ® -->
                <div class="formula-example">
                    <h4 class="info-label">ğŸ“Š ç¤ºä¾‹</h4>
                    <div class="example-detail">
                        <div class="example-params">
                            <span class="example-item">äº¬ä¸œä»·: 50å…ƒ</span>
                            <span class="example-item">åˆ°æ‰‹ä»·: 38å…ƒ</span>
                            <span class="example-item">é‡‡è´­ä»·: 30å…ƒ</span>
                            <span class="example-item">æ‰¿è¯ºæ¯›ä¿: 20%</span>
                        </div>
                        <div class="example-calc">
                            <p><strong>è®¡ç®—è¿‡ç¨‹ï¼š</strong></p>
                            <p>æ¯›ä¿è¡¥å·® = 38 Ã— 0.2 - (38 - 30) = 7.6 - 8 = <strong>-0.4å…ƒ</strong></p>
                            <p class="result-note success">å› ä¸ºè¡¥å·® &lt; 0ï¼Œæ— éœ€è¡¥å·®ï¼Œå®é™…å›æ¬¾ = é‡‡è´­ä»· = 30å…ƒ</p>
                        </div>
                    </div>
                </div>

                <!-- ä¸´ç•Œç‚¹åˆ†æ -->
                <div class="formula-critical">
                    <h4 class="info-label">ğŸ“ ä¸´ç•Œç‚¹åˆ†æ</h4>
                    <div class="critical-content">
                        <p>è®¾åˆ°æ‰‹ä»·ä¸º xï¼Œä»¤æ¯›ä¿è¡¥å·® = 0ï¼š</p>
                        <div class="critical-formula">
                            <p>x Ã— æ‰¿è¯ºæ¯›ä¿ - (x - é‡‡è´­ä»·) = 0</p>
                            <p>x Ã— æ‰¿è¯ºæ¯›ä¿ = x - é‡‡è´­ä»·</p>
                            <p>x Ã— (æ‰¿è¯ºæ¯›ä¿ - 1) = -é‡‡è´­ä»·</p>
                            <p>x = é‡‡è´­ä»· Ã· (1 - æ‰¿è¯ºæ¯›ä¿)</p>
                        </div>
                        <p class="critical-example">
                            ç¤ºä¾‹ï¼šé‡‡è´­ä»·30å…ƒï¼Œæ‰¿è¯ºæ¯›ä¿20%<br>
                            ä¸´ç•Œç‚¹ = 30 Ã· (1 - 0.2) = 30 Ã· 0.8 = <strong>37.5å…ƒ</strong><br>
                            å³åˆ°æ‰‹ä»· â‰¥ 37.5å…ƒæ—¶ï¼Œæ— éœ€è¡¥å·®ï¼ˆç‰¹æ®Šçº¦å®šé™¤å¤–ï¼‰
                        </p>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šè®¡ç®—å™¨ -->
            <div class="formula-calculator">
                <h4 class="calculator-title">ğŸ§® åœ¨çº¿è®¡ç®—</h4>
                <form class="calculator-form" id="maobao-form">
                    <div class="input-group">
                        <label for="jd_price">äº¬ä¸œä»·</label>
                        <div class="input-wrapper">
                            <input type="number" 
                                   id="jd_price" 
                                   name="jd_price"
                                   class="calc-input"
                                   placeholder="è¯·è¾“å…¥"
                                   step="0.01"
                                   min="0">
                            <span class="input-unit">å…ƒ</span>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label for="final_price">åˆ°æ‰‹ä»·</label>
                        <div class="input-wrapper">
                            <input type="number" 
                                   id="final_price" 
                                   name="final_price"
                                   class="calc-input"
                                   placeholder="è¯·è¾“å…¥"
                                   step="0.01"
                                   min="0">
                            <span class="input-unit">å…ƒ</span>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label for="purchase_price">é‡‡è´­ä»·</label>
                        <div class="input-wrapper">
                            <input type="number" 
                                   id="purchase_price" 
                                   name="purchase_price"
                                   class="calc-input"
                                   placeholder="è¯·è¾“å…¥"
                                   step="0.01"
                                   min="0">
                            <span class="input-unit">å…ƒ</span>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label for="maobao_rate">æ‰¿è¯ºæ¯›ä¿</label>
                        <div class="input-wrapper">
                            <input type="number" 
                                   id="maobao_rate" 
                                   name="maobao_rate"
                                   class="calc-input"
                                   placeholder="è¯·è¾“å…¥"
                                   step="0.1"
                                   min="0"
                                   max="100">
                            <span class="input-unit">%</span>
                        </div>
                    </div>
                    
                    <button type="button" class="calc-button" onclick="calculateMaobao()">
                        è®¡ç®—ç»“æœ
                    </button>
                    
                    <div class="calc-result" id="maobao_result">
                        <span class="result-label">è®¡ç®—ç»“æœ</span>
                        <div class="result-details">
                            <div class="result-item">
                                <span class="result-name">æ¯›ä¿è¡¥å·®</span>
                                <span class="result-value" id="result_bucha">--</span>
                                <span class="result-unit">å…ƒ</span>
                            </div>
                            <div class="result-item">
                                <span class="result-name">æ˜¯å¦è¡¥å·®</span>
                                <span class="result-value" id="result_status">--</span>
                            </div>
                            <div class="result-item">
                                <span class="result-name">å®é™…å›æ¬¾</span>
                                <span class="result-value" id="result_huikuan">--</span>
                                <span class="result-unit">å…ƒ</span>
                            </div>
                            <div class="result-item">
                                <span class="result-name">ä¸´ç•Œåˆ°æ‰‹ä»·</span>
                                <span class="result-value" id="result_critical">--</span>
                                <span class="result-unit">å…ƒ</span>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</section>

<!-- è¿”å›é“¾æ¥ -->
<section class="related-section">
    <h3 class="related-title">è¿”å›</h3>
    <div class="related-grid">
        <a href="{{ url_for('platform_index', platform_id='jd') }}" class="related-card">
            <span class="related-icon">ğŸ“¦</span>
            <span class="related-name">äº¬ä¸œé¦–é¡µ</span>
        </a>
        {% for metric_id, metric_info in metrics.items() %}
        <a href="{{ url_for('platform_metric', platform_id='jd', metric_id=metric_id) }}" class="related-card">
            <span class="related-icon">{{ metric_info.icon }}</span>
            <span class="related-name">{{ metric_info.title }}</span>
        </a>
        {% endfor %}
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
function calculateMaobao() {
    const jdPrice = parseFloat(document.getElementById('jd_price').value);
    const finalPrice = parseFloat(document.getElementById('final_price').value);
    const purchasePrice = parseFloat(document.getElementById('purchase_price').value);
    const maobaoRate = parseFloat(document.getElementById('maobao_rate').value) / 100;
    
    const resultDiv = document.getElementById('maobao_result');
    const buchaEl = document.getElementById('result_bucha');
    const statusEl = document.getElementById('result_status');
    const huikuanEl = document.getElementById('result_huikuan');
    const criticalEl = document.getElementById('result_critical');
    
    // éªŒè¯è¾“å…¥
    const inputs = document.querySelectorAll('#maobao-form .calc-input');
    let allFilled = true;
    
    inputs.forEach(input => {
        const value = parseFloat(input.value);
        if (isNaN(value) || input.value === '') {
            allFilled = false;
            input.classList.add('error');
        } else {
            input.classList.remove('error');
        }
    });
    
    if (!allFilled) {
        buchaEl.textContent = 'è¯·å¡«å†™æ‰€æœ‰å­—æ®µ';
        resultDiv.classList.add('error');
        resultDiv.classList.remove('success');
        return;
    }
    
    // è®¡ç®—æ¯›ä¿è¡¥å·®
    // æ¯›ä¿è¡¥å·® = åˆ°æ‰‹ä»· Ã— æ‰¿è¯ºæ¯›ä¿ - (åˆ°æ‰‹ä»· - é‡‡è´­ä»·)
    const bucha = finalPrice * maobaoRate - (finalPrice - purchasePrice);
    
    // è®¡ç®—ä¸´ç•Œç‚¹
    // ä¸´ç•Œç‚¹ = é‡‡è´­ä»· Ã· (1 - æ‰¿è¯ºæ¯›ä¿)
    const critical = purchasePrice / (1 - maobaoRate);
    
    // è®¡ç®—å®é™…å›æ¬¾
    let huikuan;
    let status;
    
    if (bucha < 0) {
        // æ— éœ€è¡¥å·®
        huikuan = purchasePrice;
        status = 'æ— éœ€è¡¥å·®';
        statusEl.classList.add('success-text');
        statusEl.classList.remove('warning-text');
    } else {
        // éœ€è¦è¡¥å·®
        huikuan = purchasePrice - bucha;
        status = 'éœ€è¦è¡¥å·®';
        statusEl.classList.add('warning-text');
        statusEl.classList.remove('success-text');
    }
    
    // æ˜¾ç¤ºç»“æœ
    buchaEl.textContent = bucha.toFixed(2);
    statusEl.textContent = status;
    huikuanEl.textContent = huikuan.toFixed(2);
    criticalEl.textContent = critical.toFixed(2);
    
    resultDiv.classList.remove('error');
    resultDiv.classList.add('success');
    
    // åŠ¨ç”»æ•ˆæœ
    resultDiv.classList.add('animate');
    setTimeout(() => resultDiv.classList.remove('animate'), 300);
}

// è¾“å…¥æ¡†äº‹ä»¶
document.querySelectorAll('#maobao-form .calc-input').forEach(input => {
    input.addEventListener('input', function() {
        this.classList.remove('error');
        const resultDiv = document.getElementById('maobao_result');
        resultDiv.classList.remove('success', 'error');
    });
    
    input.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            calculateMaobao();
        }
    });
});
</script>
{% endblock %}

{% set platforms = platforms %}
{% set metrics = metrics %}

